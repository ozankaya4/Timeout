{% extends "base.html" %}
{% load static %}
{% block title %}Deadlines — Timeout{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/deadlines.css' %}">
{% endblock %}

{% block content %}
<div class="dl-page">
  <div class="dl-card">

    <!-- Toolbar -->
    <div class="dl-toolbar">
      <div class="dl-toolbar__left">
        <h1 class="dl-title">Deadlines</h1>
        {% if overdue_count > 0 %}
        <span class="dl-badge dl-badge--overdue">{{ overdue_count }} overdue</span>
        {% endif %}
        {% if urgent_count > 0 %}
        <span class="dl-badge dl-badge--urgent">{{ urgent_count }} urgent</span>
        {% endif %}
      </div>
      <div class="dl-toolbar__right">
        <!-- View Switcher -->
        <div class="dl-view-switcher">
          <a href="{% url 'calendar' %}" class="dl-view-btn">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="2" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
              <path d="M1 6h14" stroke="currentColor" stroke-width="1.5"/>
              <path d="M5 1v3M11 1v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Calendar
          </a>
          <a href="{% url 'deadline_list' %}" class="dl-view-btn dl-view-btn--active">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 4h12M2 8h12M2 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            List
          </a>
        </div>
        <a href="#" class="dl-add-btn" data-bs-toggle="modal" data-bs-target="#addEventModal">
          + <span class="dl-add-label">Add Deadline</span>
        </a>
      </div>
    </div>

    <!-- Deadline List -->
    <div class="dl-list">
      {% if deadlines %}
        {% for item in deadlines %}
        <div class="dl-item dl-item--{{ item.urgency_status }}" data-id="{{ item.event.id }}">
          <div class="dl-item__check">
            <input
              type="checkbox"
              class="dl-checkbox"
              id="dl-check-{{ item.event.id }}"
              data-event-id="{{ item.event.id }}"
              aria-label="Mark '{{ item.event.title }}' as complete"
            >
          </div>
          <div class="dl-item__body">
            <div class="dl-item__header">
              <span class="dl-item__title">{{ item.event.title }}</span>
              <span class="dl-urgency-tag dl-urgency-tag--{{ item.urgency_status }}">
                {% if item.urgency_status == 'overdue' %}Overdue
                {% elif item.urgency_status == 'urgent' %}Urgent
                {% else %}On Track
                {% endif %}
              </span>
            </div>
            {% if item.event.description %}
            <p class="dl-item__desc">{{ item.event.description|truncatewords:20 }}</p>
            {% endif %}
            <div class="dl-item__meta">
              <span class="dl-meta dl-meta--time">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                  <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.2"/>
                  <path d="M7 4v3l2 1.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                </svg>
                {{ item.time_remaining_display }}
              </span>
              <span class="dl-meta dl-meta--added">{{ item.time_elapsed_display }}</span>
              {% if item.event.location %}
              <span class="dl-meta dl-meta--location">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                  <path d="M7 1C4.79 1 3 2.79 3 5c0 3.5 4 7.5 4 7.5s4-4 4-7.5c0-2.21-1.79-4-4-4z" stroke="currentColor" stroke-width="1.2"/>
                  <circle cx="7" cy="5" r="1.5" stroke="currentColor" stroke-width="1.2"/>
                </svg>
                {{ item.event.location }}
              </span>
              {% endif %}
              <span class="dl-meta dl-meta--due">Due {{ item.event.end_datetime|date:"D, d M Y \a\t H:i" }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="dl-empty">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="24" cy="24" r="20" stroke="#c8cfe0" stroke-width="2"/>
            <path d="M16 24l5 5 11-11" stroke="#c8cfe0" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="dl-empty__text">No active deadlines — you're all caught up!</p>
          <a href="#" class="dl-add-btn" data-bs-toggle="modal" data-bs-target="#addEventModal">+ Add Deadline</a>
        </div>
      {% endif %}
    </div>

  </div>
</div>

<!-- Add Event Modal (reused from calendar, preset to deadline) -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEventLabel">Add Deadline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'event_create' %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{% url 'deadline_list' %}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="eventTitle" name="title" placeholder="e.g. Algorithms Problem Set 3" required>
          </div>
          <div class="mb-3">
            <label for="eventType" class="form-label">Type</label>
            <select class="form-select" id="eventType" name="event_type">
              <option value="deadline" selected>Deadline</option>
              <option value="exam">Exam</option>
              <option value="class">Class</option>
              <option value="meeting">Meeting</option>
              <option value="study_session">Study Session</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="eventStart" class="form-label">Due Date</label>
              <input type="datetime-local" class="form-control" id="eventStart" name="start_datetime" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="eventEnd" class="form-label">End</label>
              <input type="datetime-local" class="form-control" id="eventEnd" name="end_datetime" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="eventLocation" class="form-label">Location <small class="text-muted">(optional)</small></label>
            <input type="text" class="form-control" id="eventLocation" name="location" placeholder="e.g. Bush House Room 2.1">
          </div>
          <div class="mb-3">
            <label for="eventDesc" class="form-label">Description <small class="text-muted">(optional)</small></label>
            <textarea class="form-control" id="eventDesc" name="description" rows="2" placeholder="Any extra details..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-nep text-white">Add Deadline</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Mobile FAB -->
<a href="#" class="dl-fab" data-bs-toggle="modal" data-bs-target="#addEventModal" aria-label="Add deadline">+</a>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.dl-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      var eventId = this.dataset.eventId;
      completeDeadline(eventId, this);
    });
  });
});

function completeDeadline(eventId, checkbox) {
  var item = document.querySelector('[data-id="' + eventId + '"]');

  fetch('/deadlines/' + eventId + '/complete/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
        || getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(function(res) {
    if (!res.ok) throw new Error('Request failed');
    return res.json();
  })
  .then(function(data) {
    if (data.is_completed && item) {
      checkbox.disabled = true;
      item.classList.add('dl-item--completing');
      setTimeout(function() {
        item.remove();
        if (document.querySelectorAll('.dl-item').length === 0) {
          location.reload();
        }
      }, 400);
    }
  })
  .catch(function(err) {
    console.error('Complete failed:', err);
    checkbox.checked = false;
  });
}

function getCookie(name) {
  var cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
      var cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}