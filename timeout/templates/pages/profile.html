{% extends 'base.html' %}
{% load static %}

{% block title %}
  My Profile - Timeout
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/profile.css' %}" />
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <!-- Profile Header -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex align-items-start gap-3">
              <!-- Profile picture -->
              <div>
                {% if user.profile_picture %}
                  <img src="{{ user.profile_picture.url }}" alt="Profile picture" class="profile-avatar" />
                {% else %}
                  <div class="profile-avatar profile-avatar-fallback">{{ user.username|first|upper }}</div>
                {% endif %}
              </div>
              <div>
                <h3>@{{ user.username }}</h3>
                {% if user.get_full_name %}
                  <p class="text-muted mb-1">{{ user.get_full_name }}</p>
                {% endif %}
                {% if user.bio %}
                  <p class="mt-2">{{ user.bio }}</p>
                {% endif %}
                <div class="text-muted small">
                  {% if user.university %}
                    <span>ðŸŽ“ {{ user.university }}</span>
                  {% endif %}
                  {% if user.year_of_study %}
                    <span class="ms-2">Year {{ user.year_of_study }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="mt-3">
              <span class="badge bg-light text-dark me-2">{{ posts|length }} Posts</span>
              <span class="badge bg-light text-dark me-2">{{ user.follower_count }} Followers</span>
              <span class="badge bg-light text-dark">{{ user.following_count }} Following</span>
            </div>
          </div>
        </div>

        <!-- Status Setter -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">My Status</h5>
            <p class="text-muted small mb-3">
              Current: <strong id="current-status-display">{{ user.get_status_display }}</strong>
            </p>
            <div class="d-flex gap-2 flex-wrap">
              {% for value, label in status_choices %}
                <button class="btn status-btn {% if user.status == value %}
                    btn-primary
                  {% else %}
                    btn-outline-secondary
                  {% endif %}"
                  data-status="{{ value }}">
                  {{ label }}
                </button>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- My Posts -->
        <h4 class="mb-3">My Posts</h4>
        {% if posts %}
          {% for post in posts %}
            {% include 'social/_post_card.html' with post=post %}
          {% endfor %}
        {% else %}
          <div class="alert alert-info">You haven't posted anything yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {% load static %}
  <script src="{% static 'js/social.js' %}"></script>
  <script>
    document.querySelectorAll('.status-btn').forEach((btn) => {
      btn.addEventListener('click', function () {
        const status = this.dataset.status
        fetch("{% url 'update_status' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: `status=${status}`
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.status) {
              document.getElementById('current-status-display').textContent = data.status_display
              document.querySelectorAll('.status-btn').forEach((b) => {
                b.classList.remove('btn-primary')
                b.classList.add('btn-outline-secondary')
              })
              this.classList.remove('btn-outline-secondary')
              this.classList.add('btn-primary')
            }
          })
      })
    })
  </script>
{% endblock %}
